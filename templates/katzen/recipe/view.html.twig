{% extends 'katzen/base.html.twig' %}

{% block main_content %}
<div class="container py-4">
  {# Header with title and actions #}
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="mb-1">{{ recipe.title }}</h1>
      <span class="badge bg-{{ recipe.status == 'active' ? 'success' : (recipe.status == 'draft' ? 'secondary' : 'warning') }}">
        {{ recipe.status|capitalize }}
      </span>
    </div>
    <div class="btn-group">
      <a href="{{ path('recipe_table') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to List
      </a>
      <a href="{{ path('recipe_build') }}" class="btn btn-outline-primary">
        <i class="bi bi-pencil me-1"></i> Edit
      </a>
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
        <i class="bi bi-trash me-1"></i> Delete
      </button>
    </div>
  </div>

  {% if recipe.summary %}
  <p class="lead text-muted">{{ recipe.summary }}</p>
  {% endif %}

  <div class="row">
    {# Left column: Recipe details #}
    <div class="col-lg-8">
      {# Instructions #}
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-list-ol me-2"></i>Instructions
        </div>
        <div class="card-body">
          <ol class="mb-0">
            {% for instruction in recipe.recipeInstructions %}
            <li class="mb-2">{{ instruction.description }}</li>
            {% else %}
            <li class="text-muted">No instructions listed</li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>

    <div class='col-lg-4'>
      {# Ingredients #}
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-basket me-2"></i>Ingredients
        </div>
        <ul class="list-group list-group-flush">
          {% for ingredient in recipe_ingredients %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ ingredient.supplyLabel }}</span>
            <span class="badge bg-light text-dark">
              {{ ingredient.quantity|mixed_fraction }} {{ ingredient.unit }}
            </span>
          </li>
          {% else %}
          <li class="list-group-item text-muted">No ingredients listed</li>
          {% endfor %}
        </ul>
      </div>

      {# Timing info #}
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-clock me-2"></i>Timing
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <div class="fs-4 fw-bold text-primary">{{ recipe.prepTime }}</div>
              <small class="text-muted">Prep (min)</small>
            </div>
            <div class="col-4">
              <div class="fs-4 fw-bold text-warning">{{ recipe.cookTime }}</div>
              <small class="text-muted">Cook (min)</small>
            </div>
            <div class="col-4">
              <div class="fs-4 fw-bold text-secondary">{{ recipe.waitTime }}</div>
              <small class="text-muted">Wait (min)</small>
            </div>
          </div>
        </div>
      </div>
      
      {# Meta info #}
      <div class="card">
        <div class="card-header">
          <i class="bi bi-info-circle me-2"></i>Details
        </div>
        <ul class="list-group list-group-flush small">
          <li class="list-group-item d-flex justify-content-between">
            <span class="text-muted">ID</span>
            <span>{{ recipe.id }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Servings</span>
            <span>{{ recipe.servingMinQty }}{% if recipe.servingMaxQty %}-{{ recipe.servingMaxQty }}{% endif %} {{ recipe.servingUnit }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Created</span>
            <span>{{ recipe.createdAt|date('M j, Y') }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Updated</span>
            <span>{{ recipe.updatedAt|date('M j, Y') }}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Version</span>
            <span>{{ recipe.version }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

{# Delete Modal #}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Recipe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ recipe.title }}</strong>?</p>
        
        {% if deletion_report is defined and deletion_report and not deletion_report.ok %}
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-1"></i>
          <strong>Warning:</strong> {{ deletion_report.reasons|join(' ') }}
        </div>
        {% endif %}

        <form id="deleteForm" method="post" action="{{ path('recipe_delete', {id: recipe.id}) }}">
          <input type="hidden" name="_token" value="{{ csrf_token('delete_recipe_' ~ recipe.id) }}">
          
          <div class="mb-3">
            <label class="form-label">Delete Mode</label>
            <select name="mode" class="form-select">
              <option value="block" selected>Block if referenced (safe)</option>
              <option value="soft">Archive only (soft delete)</option>
              <option value="force">Force with invalidations</option>
            </select>
            <div class="form-text">
              <strong>Block:</strong> Won't delete if used in orders, menus, or other recipes.<br>
              <strong>Archive:</strong> Sets status to 'archived' but keeps data.<br>
              <strong>Force:</strong> Removes from menus, nullifies order refs, then archives.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="deleteForm" class="btn btn-danger">
          <i class="bi bi-trash me-1"></i> Delete Recipe
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
