{% block title %}Receipt {{ receipt.receiptNumber }}{% endblock %}

{% block main_content %}
<div class="container-fluid my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Receipt {{ receipt.receiptNumber }}</h2>
    <div>
      <a href="{{ path('receipt_index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Receipts
      </a>
      <button onclick="window.print()" class="btn btn-outline-primary">
        <i class="bi bi-printer me-2"></i>Print
      </button>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Receipt Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Receipt Number:</dt>
                <dd class="col-sm-7">{{ receipt.receiptNumber }}</dd>
                
                <dt class="col-sm-5">Status:</dt>
                <dd class="col-sm-7">
                  <span class="badge bg-{{ receipt.status == 'completed' ? 'success' : 'warning' }}">
                    {{ receipt.status|upper }}
                  </span>
                </dd>
                
                <dt class="col-sm-5">PO Number:</dt>
                <dd class="col-sm-7">
                  <a href="{{ path('purchase_show', {id: receipt.purchase.id}) }}">
                    {{ receipt.purchase.poNumber }}
                  </a>
                </dd>
                
                <dt class="col-sm-5">Vendor:</dt>
                <dd class="col-sm-7">{{ receipt.purchase.vendor.name }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Location:</dt>
                <dd class="col-sm-7">{{ receipt.location.name }}</dd>
                
                <dt class="col-sm-5">Received Date:</dt>
                <dd class="col-sm-7">{{ receipt.receivedAt|date('Y-m-d H:i') }}</dd>
                
                <dt class="col-sm-5">Created:</dt>
                <dd class="col-sm-7">{{ receipt.createdAt|date('Y-m-d H:i') }}</dd>
              </dl>
            </div>
          </div>
          
          {% if receipt.notes %}
          <div class="mt-3">
            <strong>Notes:</strong>
            <p class="text-muted mb-0">{{ receipt.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Received Items</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Item</th>
                  <th class="text-center">Qty Received</th>
                  <th>Unit Cost</th>
                  <th>Line Total</th>
                  <th>Lot Number</th>
                  <th>Expiration</th>
                </tr>
              </thead>
              <tbody>
                {% for item in receipt.stockReceiptItems %}
                <tr>
                  <td>
                    <strong>{{ item.stockTarget.name }}</strong>
                    <div class="text-muted small">
                      Unit: {{ item.stockTarget.baseUnit.abbreviation }}
                    </div>
                  </td>
                  <td class="text-center">{{ item.qtyReceived }}</td>
                  <td>${{ item.unitCost|number_format(2) }}</td>
                  <td><strong>${{ item.lineTotal|number_format(2) }}</strong></td>
                  <td>
                    {% if item.lotNumber %}
                      <span class="badge bg-secondary">{{ item.lotNumber }}</span>
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if item.expirationDate %}
                      {{ item.expirationDate|date('Y-m-d') }}
                      {% set daysUntilExpiration = date(item.expirationDate).diff(date()).days %}
                      {% if daysUntilExpiration < 30 %}
                        <span class="badge bg-warning">{{ daysUntilExpiration }}d</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                </tr>
                {% if item.notes %}
                <tr>
                  <td colspan="6" class="border-0 pt-0">
                    <small class="text-muted">
                      <i class="bi bi-chat-left-text me-1"></i>{{ item.notes }}
                    </small>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="3" class="text-end"><strong>Total:</strong></td>
                  <td colspan="3"><strong>${{ receipt.totalAmount|number_format(2) }}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Lot Details</h5>
        </div>
        <div class="card-body">
          {% set lotCount = 0 %}
          {% for item in receipt.stockReceiptItems %}
            {% for lot in item.stockLots %}
              {% set lotCount = lotCount + 1 %}
              <div class="border-bottom pb-3 mb-3">
                <h6 class="text-primary">{{ lot.lotNumber }}</h6>
                <dl class="row small mb-0">
                  <dt class="col-6">Item:</dt>
                  <dd class="col-6">{{ lot.stockTarget.name }}</dd>
                  
                  <dt class="col-6">Initial Qty:</dt>
                  <dd class="col-6">{{ lot.initialQty }}</dd>
                  
                  <dt class="col-6">Current Qty:</dt>
                  <dd class="col-6">{{ lot.currentQty }}</dd>
                  
                  {% if lot.expirationDate %}
                  <dt class="col-6">Expires:</dt>
                  <dd class="col-6">{{ lot.expirationDate|date('Y-m-d') }}</dd>
                  {% endif %}
                  
                  <dt class="col-6">Location:</dt>
                  <dd class="col-6">
                    {% for balance in lot.locationBalances %}
                      {{ balance.location.name }}
                    {% endfor %}
                  </dd>
                </dl>
              </div>
            {% endfor %}
          {% endfor %}
          
          {% if lotCount == 0 %}
            <p class="text-muted mb-0">No lot information available</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Accounting Entry</h5>
        </div>
        <div class="card-body">
          <p class="small text-muted mb-2">Journal entry created:</p>
          <dl class="row small mb-0">
            <dt class="col-6">Inventory (Dr):</dt>
            <dd class="col-6 text-end">${{ receipt.totalAmount|number_format(2) }}</dd>
            
            <dt class="col-6">AP (Cr):</dt>
            <dd class="col-6 text-end">${{ receipt.totalAmount|number_format(2) }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
