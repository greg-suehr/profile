{% extends 'katzen/_dashboard_base.html.twig' %}

{% block title %}Import Dashboard{% endblock %}

{% block main_content %}
<div class="import-dashboard">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-cloud-upload me-2"></i>
        Data Import
      </h2>
      <p class="text-muted mb-0">Manage imports, mappings, and view import history</p>
    </div>
    <div class="btn-group">
      <a href="{{ path('import_upload') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>
        New Import
      </a>
      <a href="{{ path('import_mappings') }}" class="btn btn-outline-secondary">
        <i class="bi bi-gear me-1"></i>
        Mappings
      </a>
    </div>
  </div>

  {% if stats.active_count > 0 %}
  <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
    <div class="spinner-border spinner-border-sm me-3" role="status">
      <span class="visually-hidden">Processing...</span>
    </div>
    <div class="flex-grow-1">
      <strong>{{ stats.active_count }} import{{ stats.active_count > 1 ? 's' : '' }} in progress</strong>
      {% for batch in active_batches %}
        <span class="badge bg-info ms-2">{{ batch.name ?: 'Batch #' ~ batch.id }}</span>
      {% endfor %}
    </div>
    <a href="{{ path('import_batches', {status: 'processing'}) }}" class="btn btn-sm btn-outline-info">
      View Active
    </a>
  </div>
  {% endif %}

  <div class="row g-3 mb-4">
    
    <div class="col-6 col-lg-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Total Imports</h6>
              <h3 class="mb-0">{{ stats.total_batches }}</h3>
            </div>
            <div class="bg-primary bg-opacity-10 rounded-3 p-2">
              <i class="bi bi-archive text-primary" style="font-size: 1.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Records Imported</h6>
              <h3 class="mb-0">{{ stats.total_rows }}</h3>
            </div>
            <div class="bg-success bg-opacity-10 rounded-3 p-2">
              <i class="bi bi-database text-success" style="font-size: 1.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Success Rate</h6>
              <h3 class="mb-0 {{ stats.success_rate >= 95 ? 'text-success' : (stats.success_rate >= 80 ? 'text-warning' : 'text-danger') }}">
                {{ stats.success_rate }}%
              </h3>
            </div>
            <div class="bg-{{ stats.success_rate >= 95 ? 'success' : (stats.success_rate >= 80 ? 'warning' : 'danger') }} bg-opacity-10 rounded-3 p-2">
              <i class="bi bi-{{ stats.success_rate >= 95 ? 'check-circle' : (stats.success_rate >= 80 ? 'exclamation-triangle' : 'x-circle') }} text-{{ stats.success_rate >= 95 ? 'success' : (stats.success_rate >= 80 ? 'warning' : 'danger') }}" style="font-size: 1.5rem;"></i>
            </div>
          </div>
          <div class="progress mt-2" style="height: 4px;">
            <div class="progress-bar bg-{{ stats.success_rate >= 95 ? 'success' : (stats.success_rate >= 80 ? 'warning' : 'danger') }}" 
                 role="progressbar" 
                 style="width: {{ stats.success_rate }}%" 
                 aria-valuenow="{{ stats.success_rate }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="card h-100 {{ stats.failed_rows|replace({',': ''})|number_format > 0 ? 'border-danger' : '' }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Failed Records</h6>
              <h3 class="mb-0 {{ stats.failed_rows != '0' ? 'text-danger' : '' }}">{{ stats.failed_rows }}</h3>
            </div>
            <div class="bg-danger bg-opacity-10 rounded-3 p-2">
              <i class="bi bi-exclamation-triangle text-danger" style="font-size: 1.5rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  </div>

  <div class="row g-4 mb-4">
    
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-transparent">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart me-2"></i>
            Import Status Breakdown
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex flex-column gap-2">
            
            {% set status_config = {
              'completed': { 'label': 'Completed', 'color': 'success', 'icon': 'check-circle' },
              'processing': { 'label': 'Processing', 'color': 'info', 'icon': 'arrow-repeat' },
              'pending': { 'label': 'Pending', 'color': 'secondary', 'icon': 'clock' },
              'failed': { 'label': 'Failed', 'color': 'danger', 'icon': 'x-circle' },
              'rolled_back': { 'label': 'Rolled Back', 'color': 'warning', 'icon': 'arrow-counterclockwise' }
            } %}
            
            {% for status, count in status_counts %}
            {% set config = status_config[status] ?? { 'label': status|capitalize, 'color': 'secondary', 'icon': 'circle' } %}
            <a href="{{ path('import_batches', {status: status}) }}" 
               class="d-flex justify-content-between align-items-center p-2 rounded text-decoration-none text-body hover-bg-light">
              <span>
                <i class="bi bi-{{ config.icon }} text-{{ config.color }} me-2"></i>
                {{ config.label }}
              </span>
              <span class="badge bg-{{ config.color }}">{{ count }}</span>
            </a>
            {% else %}
            <p class="text-muted mb-0">No imports yet</p>
            {% endfor %}
            
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-diagram-3 me-2"></i>
            Configured Mappings
          </h5>
          <a href="{{ path('import_mappings') }}" class="btn btn-sm btn-outline-primary">
            Manage
          </a>
        </div>
        <div class="card-body">
          {% if mapping_counts|length > 0 %}
          <div class="d-flex flex-column gap-2">
            
            {% set entity_config = {
              'order': { 'label': 'Orders', 'color': 'primary', 'icon': 'receipt' },
              'item': { 'label': 'Items', 'color': 'success', 'icon': 'box' },
              'sellable': { 'label': 'Sellables', 'color': 'info', 'icon': 'tag' },
              'customer': { 'label': 'Customers', 'color': 'warning', 'icon': 'people' },
              'vendor': { 'label': 'Vendors', 'color': 'secondary', 'icon': 'truck' }
            } %}
            
            {% for entity_type, count in mapping_counts %}
            {% set config = entity_config[entity_type] ?? { 'label': entity_type|capitalize, 'color': 'secondary', 'icon': 'file-earmark' } %}
            <a href="{{ path('import_mappings', {type: entity_type}) }}" 
               class="d-flex justify-content-between align-items-center p-2 rounded text-decoration-none text-body hover-bg-light">
              <span>
                <i class="bi bi-{{ config.icon }} text-{{ config.color }} me-2"></i>
                {{ config.label }}
              </span>
              <span class="badge bg-{{ config.color }}">{{ count }} mapping{{ count != 1 ? 's' : '' }}</span>
            </a>
            {% endfor %}
            
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-gear text-muted" style="font-size: 2rem;"></i>
            <p class="text-muted mt-2 mb-3">No mappings configured yet</p>
            <a href="{{ path('import_upload') }}" class="btn btn-sm btn-primary">
              Create Your First Import
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    
  </div>

  <div class="card">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-clock-history me-2"></i>
        Recent Imports
      </h5>
      <a href="{{ path('import_batches') }}" class="btn btn-sm btn-outline-secondary">
        View All
      </a>
    </div>
    <div class="card-body p-0">
      {% include 'katzen/component/_table_view.html.twig' with { table: table } %}
    </div>
  </div>

</div>

<style>
  .hover-bg-light:hover {
    background-color: rgba(0,0,0,0.03);
  }
  
  .import-dashboard .card {
    border-radius: 0.5rem;
    border-color: rgba(0,0,0,0.1);
  }
  
  .import-dashboard .card-header {
    border-bottom-color: rgba(0,0,0,0.05);
  }
</style>
{% endblock %}
