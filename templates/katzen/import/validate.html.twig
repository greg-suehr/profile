{% extends 'katzen/_dashboard_base.html.twig' %}

{% block title %}Validate Import{% endblock %}

{% block main_content %}
<div class="import-validate">

  <div class="mb-4">
    <div class="d-flex align-items-center mb-2">
      <a href="{{ path('import_plan') }}" class="btn btn-sm btn-outline-secondary me-3">
        <i class="bi bi-arrow-left"></i>
      </a>
      <div>
        <h2 class="mb-1">
          <i class="bi bi-shield-check me-2"></i>
          Validate Import
        </h2>
        <p class="text-muted mb-0">
          Confirm required mappings and review estimated creates for <span class="fw-semibold">{{ file_name }}</span>
        </p>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row text-center">
        <div class="col-3">
          <div class="wizard-step completed">
            <div class="wizard-step-icon bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 wizard-step-icon--size">
              <i class="bi bi-check-lg"></i>
            </div>
            <div class="fw-semibold text-success">Upload</div>
            <div class="small text-muted">Complete</div>
          </div>
        </div>
        <div class="col-3">
          <div class="wizard-step completed">
            <div class="wizard-step-icon bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 wizard-step-icon--size">
              <i class="bi bi-check-lg"></i>
            </div>
            <div class="fw-semibold text-success">Plan</div>
            <div class="small text-muted">Complete</div>
          </div>
        </div>
        <div class="col-3">
          <div class="wizard-step active">
            <div class="wizard-step-icon bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 wizard-step-icon--size">
              <i class="bi bi-shield-check"></i>
            </div>
            <div class="fw-semibold">Validate</div>
            <div class="small text-muted">Completeness & estimates</div>
          </div>
        </div>
        <div class="col-3">
          <div class="wizard-step">
            <div class="wizard-step-icon bg-light text-muted rounded-circle d-inline-flex align-items-center justify-content-center mb-2 wizard-step-icon--size">
              <i class="bi bi-play-fill"></i>
            </div>
            <div class="text-muted">Import</div>
            <div class="small text-muted">Execute</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% set enabled_count = config.enabled_entities|length %}
  {% set estimated_total_entities = 0 %}
  {% for entityType, est in total_estimates.entities_to_create %}
    {% set estimated_total_entities = estimated_total_entities + (est ?? 0) %}
  {% endfor %}

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card border-primary h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
            </div>
            <div>
              <div class="text-muted small">Total Rows</div>
              <div class="h4 mb-0">{{ total_estimates.total_rows|number_format }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-secondary h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-secondary bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-layers text-secondary" style="font-size: 2rem;"></i>
            </div>
            <div>
              <div class="text-muted small">Enabled Entities</div>
              <div class="h4 mb-0">{{ enabled_count|number_format }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-success h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-plus-circle text-success" style="font-size: 2rem;"></i>
            </div>
            <div>
              <div class="text-muted small">Estimated Creates</div>
              <div class="h4 mb-0 text-success">{{ estimated_total_entities|number_format }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-info h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="bg-info bg-opacity-10 rounded-3 p-3 me-3">
              <i class="bi bi-star text-info" style="font-size: 2rem;"></i>
            </div>
            <div>
              <div class="text-muted small">Primary Entity</div>
              <div class="h6 mb-0">{{ config.primary_entity is defined ? (config.primary_entity|replace({'_':' '})|title) : '—' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not can_proceed %}
    <div class="alert alert-danger d-flex align-items-start mb-4">
      <i class="bi bi-exclamation-triangle-fill me-3 mt-1" style="font-size: 1.25rem;"></i>
      <div class="w-100">
        <h6 class="alert-heading mb-2">Import blocked: required mappings missing</h6>
        <p class="mb-2 small">
          One or more enabled entities are missing required fields without defaults. Return to Plan to adjust mappings.
        </p>

        <div class="mt-2">
          <ul class="mb-0 small">
            {% for entityType, result in validation_results %}
              {% set mc = result.mapping_completeness ?? {} %}
              {% if mc.missing_required is defined and mc.missing_required is not empty %}
                {% set critical_missing = mc.missing_required|filter(f => (f.has_default ?? false) == false) %}
                {% if critical_missing is not empty %}
                  <li>
                    <span class="fw-semibold">{{ result.label ?? (entityType|replace({'_':' '})|title) }}</span>:
                    {% for f in critical_missing %}
                      <code>{{ f.field }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  </li>
                {% endif %}
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-success d-flex align-items-start mb-4">
      <i class="bi bi-check-circle-fill me-3 mt-1" style="font-size: 1.25rem;"></i>
      <div>
        <h6 class="alert-heading mb-1">Ready to import</h6>
        <p class="mb-0 small">All enabled entities have required mappings satisfied (or defaults available). You can start the import.</p>
      </div>
    </div>
  {% endif %}

  <div class="row g-3 mb-4">
    {% for entityType, result in validation_results %}
      {% set mc = result.mapping_completeness ?? {} %}
      {% set percent = mc.completeness_percent ?? 100 %}
      {% set is_complete = mc.is_complete ?? true %}
      {% set missing = mc.missing_required ?? [] %}

      <div class="col-12">
        <div class="card">
          <div class="card-header bg-transparent">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div class="d-flex align-items-center">
                <i class="bi bi-diagram-3 me-2"></i>
                <span class="fw-semibold">{{ result.label ?? (entityType|replace({'_':' '})|title) }}</span>
                {% if config.primary_entity is defined and config.primary_entity == entityType %}
                  <span class="badge bg-info ms-2">Primary</span>
                {% endif %}
              </div>

              <div class="d-flex align-items-center gap-2">
                {% if is_complete %}
                  <span class="badge bg-success">Mapping complete</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Mapping incomplete</span>
                {% endif %}

                {% if result.estimated_total is defined %}
                  <span class="badge bg-light text-dark border">
                    Est. creates: {{ result.estimated_total|number_format }}
                  </span>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="text-muted small">Required mapping completeness</div>
                  <div class="small fw-semibold">{{ percent }}%</div>
                </div>
                <div class="progress" role="progressbar" aria-label="Mapping completeness" aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar{% if is_complete %} bg-success{% else %} bg-warning{% endif %}" style="width: {{ percent }}%"></div>
                </div>

                <div class="mt-2 small text-muted">
                  Mapped fields: <span class="fw-semibold">{{ mc.mapped_count ?? 0 }}</span>
                  <span class="text-muted">•</span>
                  Mapping entries: <span class="fw-semibold">{{ result.field_count ?? 0 }}</span>
                </div>

                {% if missing is not empty %}
                  <div class="mt-3">
                    <div class="small fw-semibold mb-2">Missing required fields</div>
                    <ul class="mb-0 small">
                      {% for f in missing %}
                        <li>
                          <code>{{ f.field }}</code>
                          {% if f.description is defined and f.description %}
                            <span class="text-muted">— {{ f.description }}</span>
                          {% endif %}
                          {% if f.has_default ?? false %}
                            <span class="badge bg-secondary ms-2">Default available</span>
                          {% else %}
                            <span class="badge bg-danger ms-2">Blocks import</span>
                          {% endif %}
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </div>

              <div class="col-lg-6">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="card bg-light border-0 h-100">
                      <div class="card-body">
                        <div class="text-muted small">Extractor confidence</div>
                        {% if result.confidence is defined %}
                          {% set conf = result.confidence %}
                          {% if conf is iterable %}
                            <div class="h6 mb-0">Provided</div>
                          {% else %}
                            <div class="h5 mb-0">{{ (conf * 100)|round }}%</div>
                          {% endif %}
                        {% else %}
                          <div class="h6 mb-0 text-muted">N/A</div>
                        {% endif %}
                        <div class="small text-muted mt-1">
                          {% if result.sample_count is defined %}
                            Sample records: {{ result.sample_count|number_format }}
                          {% else %}
                            No extractor configured
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="card bg-light border-0 h-100">
                      <div class="card-body">
                        <div class="text-muted small">Estimated creates</div>
                        <div class="h5 mb-0">{{ (result.estimated_total ?? 0)|number_format }}</div>
                        <div class="small text-muted mt-1">Based on sample-to-total scaling</div>
                      </div>
                    </div>
                  </div>

                  {% if result.warnings is defined and result.warnings is not empty %}
                    <div class="col-12">
                      <div class="card border-warning">
                        <div class="card-body">
                          <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
                            <span class="fw-semibold">Warnings</span>
                            <span class="badge bg-warning text-dark ms-2">{{ result.warnings|length }}</span>
                          </div>
                          <ul class="mb-0 small">
                            {% for w in result.warnings|slice(0, 8) %}
                              <li>{{ w }}</li>
                            {% endfor %}
                            {% if result.warnings|length > 8 %}
                              <li class="text-muted">…and {{ (result.warnings|length - 8) }} more</li>
                            {% endif %}
                          </ul>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>

  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <a href="{{ path('import_plan') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          Back to Plan
        </a>

        <form method="post" action="{{ path('import_execute') }}" id="execute-import-form" class="m-0">
          <input type="hidden" name="_token" value="{{ csrf_token }}">

          {% if can_proceed %}
            <button type="submit" class="btn btn-success btn-lg" id="execute-import-btn">
              <i class="bi bi-play-fill me-2"></i>
              Start Import
            </button>
          {% else %}
            <button type="button" class="btn btn-danger btn-lg" disabled>
              <i class="bi bi-x-circle me-2"></i>
              Cannot Import
            </button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>

</div>

<div class="modal fade" id="import-modal" tabindex="-1" aria-labelledby="import-modal-label" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="import-modal-label">
          <i class="bi bi-hourglass-split me-2"></i>
          Starting import…
        </h5>
      </div>
      <div class="modal-body text-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading…</span>
        </div>
        <p class="mb-0">Creating import batch and redirecting to progress.</p>
        <p class="text-muted small mb-0">If this takes longer than expected, check the batch list from the Import dashboard.</p>
      </div>
    </div>
  </div>
</div>

<style>
  .wizard-step { position: relative; }
  .wizard-step.active .wizard-step-icon { box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25); }
  .wizard-step.completed .wizard-step-icon { box-shadow: 0 0 0 4px rgba(25, 135, 84, 0.25); }
  .wizard-step-icon--size { width: 40px; height: 40px; }

  .import-validate .card {
    border-radius: 0.5rem;
    border-color: rgba(0,0,0,0.1);
  }

  .import-validate .card-header {
    border-bottom-color: rgba(0,0,0,0.05);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('execute-import-form');
    const btn = document.getElementById('execute-import-btn');
    const modalEl = document.getElementById('import-modal');

    if (!form || !btn || !modalEl) return;

    const importModal = new bootstrap.Modal(modalEl);

    form.addEventListener('submit', function() {
      // Standard POST/redirect; we just provide immediate feedback.
      importModal.show();
    });
  });
</script>
{% endblock %}
