{% block main_content %}
<div class="container-fluid my-4">
  {# Header #}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-building me-2 text-primary"></i>
        {{ vendor ? 'Edit Vendor' : 'New Vendor' }}
      </h2>
      <p class="text-muted mb-0">
        {% if vendor %}
          Update vendor information.
        {% else %}
          Add a new vendor to your system.
        {% endif %}
      </p>
    </div>
    <div>
      <a href="{{ path('vendor_index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Vendors
      </a>
    </div>
  </div>

  {# OCR Feature Callout (for new vendors) #}
  {% if not vendor %}
  <div class="alert alert-info border-start border-4 border-info shadow-sm mb-4">
    <div class="d-flex align-items-start">
      <i class="bi bi-magic fs-3 me-3 text-info"></i>
      <div>
        <h5 class="alert-heading mb-2">
          <i class="bi bi-robot me-2"></i>Intelligent OCR Matching Enabled
        </h5>
        <p class="mb-2">
          As you fill out vendor information, we automatically extract matching patterns for receipt scanning:
        </p>
        <ul class="mb-0 small">
          <li><strong>Phone numbers</strong> → Last 10 digits indexed for instant lookup</li>
          <li><strong>Website & Email</strong> → Domains extracted for brand matching</li>
          <li><strong>Address</strong> → Postal code & normalized hash for location matching</li>
          <li><strong>Tax ID</strong> → EIN matching for legal verification</li>
          <li><strong>Brand Aliases</strong> → Custom names that appear on receipts</li>
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body">
      {{ form_start(form, {'attr': {'id': 'vendor-form', 'novalidate': 'novalidate'}}) }}
      {{ form_errors(form) }}

      {# Tab Navigation #}
      <ul class="nav nav-tabs mb-4" id="vendorTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" 
                  data-bs-target="#basic" type="button" role="tab">
            <i class="bi bi-info-circle me-2"></i>Basic Info
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="contact-tab" data-bs-toggle="tab" 
                  data-bs-target="#contact" type="button" role="tab">
            <i class="bi bi-telephone me-2"></i>Contact
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="address-tab" data-bs-toggle="tab" 
                  data-bs-target="#address" type="button" role="tab">
            <i class="bi bi-geo-alt me-2"></i>Address
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                  data-bs-target="#financial" type="button" role="tab">
            <i class="bi bi-cash-stack me-2"></i>Financial
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link position-relative" id="ocr-tab" data-bs-toggle="tab" 
                  data-bs-target="#ocr" type="button" role="tab">
            <i class="bi bi-robot me-2"></i>OCR Settings
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-info">
              AI
            </span>
          </button>
        </li>
      </ul>

      {# Tab Content #}
      <div class="tab-content" id="vendorTabContent">
        
        {# ============================================================ #}
        {# BASIC INFO TAB #}
        {# ============================================================ #}
        <div class="tab-pane fade show active" id="basic" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-8">
              {{ form_row(form.name, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
            <div class="col-md-4">
              {{ form_row(form.status, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
          </div>

          <div class="row g-4 mt-2">
            <div class="col-md-6">
              {{ form_row(form.vendor_code, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
          </div>

          <div class="mt-4">
            {{ form_row(form.notes, {
              'label_attr': {'class': 'form-label fw-bold'},
              'row_attr': {'class': 'mb-3'}
            }) }}
          </div>
        </div>

        {# ============================================================ #}
        {# CONTACT TAB #}
        {# ============================================================ #}
        <div class="tab-pane fade" id="contact" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-6">
              {{ form_row(form.email, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              <div class="alert alert-light border-start border-3 border-info small">
                <i class="bi bi-info-circle me-2"></i>
                <strong>OCR Tip:</strong> Domain from email (e.g., "@sysco.com") will be automatically 
                extracted for matching receipts.
              </div>
            </div>
            <div class="col-md-6">
              {{ form_row(form.website, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              <div class="alert alert-light border-start border-3 border-info small">
                <i class="bi bi-info-circle me-2"></i>
                <strong>OCR Tip:</strong> Domain from website will be indexed for receipt matching.
              </div>
            </div>
          </div>

          <div class="row g-4 mt-2">
            <div class="col-md-6">
              {{ form_row(form.phone, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              {% if vendor and vendor.phoneDigits %}
              <div class="small text-muted">
                <i class="bi bi-check-circle text-success me-1"></i>
                Indexed digits: {{ vendor.phoneDigits }}
              </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              {{ form_row(form.fax, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
          </div>
        </div>

        {# ============================================================ #}
        {# ADDRESS TAB #}
        {# ============================================================ #}
        <div class="tab-pane fade" id="address" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-6">
              {{ form_row(form.billing_address, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              {% if vendor and vendor.postalCode %}
              <div class="alert alert-success border-0 small">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Extracted Postal:</strong> {{ vendor.postalCode }}
                <br>
                <i class="bi bi-check-circle me-2"></i>
                <strong>Address Hash:</strong> {{ vendor.addressHash[:16] }}...
              </div>
              {% else %}
              <div class="alert alert-light border-start border-3 border-info small">
                <i class="bi bi-info-circle me-2"></i>
                <strong>OCR Tip:</strong> Postal code and normalized address hash will be 
                auto-extracted for matching receipts.
              </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              {{ form_row(form.shipping_address, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-billing-address">
                <i class="bi bi-clipboard me-1"></i>Copy from Billing
              </button>
            </div>
          </div>
        </div>

        {# ============================================================ #}
        {# FINANCIAL TAB #}
        {# ============================================================ #}
        <div class="tab-pane fade" id="financial" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-6">
              {{ form_row(form.tax_id, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              <div class="alert alert-light border-start border-3 border-info small">
                <i class="bi bi-info-circle me-2"></i>
                <strong>OCR Tip:</strong> Tax ID/EIN is matched for invoice verification.
              </div>
            </div>
            <div class="col-md-6">
              {{ form_row(form.tax_classification, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
          </div>

          <div class="row g-4 mt-2">
            <div class="col-md-6">
              {{ form_row(form.payment_terms, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
          </div>

          <div class="row g-4 mt-3">
            <div class="col-md-6">
              {{ form_row(form.credit_limit, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
            </div>
            {% if vendor %}
            <div class="col-md-6">
              {{ form_row(form.current_balance, {
                'label_attr': {'class': 'form-label fw-bold'},
                'row_attr': {'class': 'mb-3'}
              }) }}
              
              {% if vendor.creditLimit and vendor.currentBalance %}
                {% set usagePercent = (vendor.currentBalance / vendor.creditLimit * 100)|round %}
                <div class="progress" style="height: 25px;">
                  <div class="progress-bar {% if usagePercent > 90 %}bg-danger{% elseif usagePercent > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                       role="progressbar" 
                       style="width: {{ usagePercent }}%">
                    {{ usagePercent }}% Used
                  </div>
                </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>

        {# ============================================================ #}
        {# OCR SETTINGS TAB #}
        {# ============================================================ #}
        <div class="tab-pane fade" id="ocr" role="tabpanel">
          <div class="alert alert-primary border-0 mb-4">
            <h5 class="alert-heading">
              <i class="bi bi-robot me-2"></i>Intelligent Receipt Matching
            </h5>
            <p class="mb-0">
              These settings improve OCR accuracy when scanning receipts. Add brand names and 
              domains as they appear on actual invoices for best results.
            </p>
          </div>

          {# Brand Aliases #}
          <div class="mb-4">
            <label class="form-label fw-bold">
              <i class="bi bi-tag me-2 text-primary"></i>Brand Aliases
            </label>
            <p class="text-muted small mb-3">
              Add alternate names that appear on receipts (e.g., "SYSCO", "SYSCO CORPORATION", "SFS")
            </p>
            
            <div id="vendor-aliases-container">
              {{ form_widget(form.vendor_aliases) }}
            </div>
            
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-alias">
              <i class="bi bi-plus-circle me-1"></i>Add Alias
            </button>
            
            {% if vendor and vendor.vendorAliases %}
            <div class="mt-3">
              <strong class="text-success">
                <i class="bi bi-check-circle me-1"></i>Current Aliases:
              </strong>
              <div class="mt-2">
                {% for alias in vendor.vendorAliases %}
                  <span class="badge bg-light text-dark border me-2 mb-2">{{ alias }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>

          {# Additional Domains #}
          <div class="mb-4">
            <label class="form-label fw-bold">
              <i class="bi bi-globe me-2 text-primary"></i>Additional Domains
            </label>
            <p class="text-muted small mb-3">
              Add other domains associated with this vendor (auto-extracted from website/email)
            </p>
            
            <div id="vendor-domains-container">
              {{ form_widget(form.vendor_domains) }}
            </div>
            
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-domain">
              <i class="bi bi-plus-circle me-1"></i>Add Domain
            </button>
            
            {% if vendor and vendor.vendorDomains %}
            <div class="mt-3">
              <strong class="text-success">
                <i class="bi bi-check-circle me-1"></i>Indexed Domains:
              </strong>
              <div class="mt-2">
                {% for domain in vendor.vendorDomains %}
                  <span class="badge bg-info text-white me-2 mb-2">
                    <i class="bi bi-globe2 me-1"></i>{{ domain }}
                  </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>

          {# OCR Matching Preview #}
          {% if vendor %}
          <div class="card bg-light border-0">
            <div class="card-body">
              <h6 class="card-title">
                <i class="bi bi-eye me-2"></i>OCR Matching Preview
              </h6>
              <p class="small text-muted mb-3">
                Here's what we'll look for when scanning receipts:
              </p>
              
              <table class="table table-sm table-borderless">
                <tbody>
                  <tr>
                    <td class="text-end" style="width: 30%;"><strong>Phone Match:</strong></td>
                    <td>
                      {% if vendor.phoneDigits %}
                        <span class="badge bg-success">{{ vendor.phoneDigits[-10:] }}</span>
                      {% else %}
                        <span class="text-muted">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>Domains:</strong></td>
                    <td>
                      {% if vendor.vendorDomains %}
                        {{ vendor.vendorDomains|join(', ') }}
                      {% else %}
                        <span class="text-muted">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>Tax ID:</strong></td>
                    <td>
                      {% if vendor.taxId %}
                        {{ vendor.taxId }}
                      {% else %}
                        <span class="text-muted">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>Postal Code:</strong></td>
                    <td>
                      {% if vendor.postalCode %}
                        {{ vendor.postalCode }}
                      {% else %}
                        <span class="text-muted">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>Aliases:</strong></td>
                    <td>
                      {% if vendor.vendorAliases %}
                        {{ vendor.vendorAliases|join(', ') }}
                      {% else %}
                        <span class="text-muted">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
        </div>

      </div> {# End tab-content #}

      {# Form Actions #}
      <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
        <a href="{{ path('vendor_index') }}" class="btn btn-link text-secondary">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </a>
        
        <div>
          {% if vendor %}
          <a href="{{ path('vendor_show', {'id': vendor.id}) }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-eye me-2"></i>View Vendor
          </a>
          {% endif %}
          
          {{ form_widget(form.submit, {
            'label': vendor ? 'Update Vendor' : 'Create Vendor',
            'attr': {'class': 'btn btn-primary btn-lg px-5'}
          }) }}
        </div>
      </div>

      {{ form_rest(form) }}
      {{ form_end(form) }}
    </div>
  </div>
</div>

{# JavaScript for Collection Types and Copy Button #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Copy billing to shipping address
  const copyBtn = document.getElementById('copy-billing-address');
  if (copyBtn) {
    copyBtn.addEventListener('click', function() {
      const billing = document.querySelector('[name*="[billing_address]"]');
      const shipping = document.querySelector('[name*="[shipping_address]"]');
      if (billing && shipping) {
        shipping.value = billing.value;
      }
    });
  }

  // Collection type handlers for aliases and domains
  function setupCollectionType(containerId, addButtonId, prototype) {
    const container = document.getElementById(containerId);
    const addButton = document.getElementById(addButtonId);
    
    if (!container || !addButton) return;
    
    let index = container.querySelectorAll('input').length;
    
    addButton.addEventListener('click', function() {
      const newForm = prototype.replace(/__name__/g, index);
      const wrapper = document.createElement('div');
      wrapper.className = 'd-flex gap-2 mb-2 align-items-start';
      wrapper.innerHTML = newForm + '<button type="button" class="btn btn-sm btn-outline-danger remove-item"><i class="bi bi-x"></i></button>';
      
      container.appendChild(wrapper);
      
      wrapper.querySelector('.remove-item').addEventListener('click', function() {
        wrapper.remove();
      });
      
      index++;
    });
    
    // Handle existing remove buttons
    container.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', function() {
        btn.closest('.d-flex').remove();
      });
    });
  }
  
  // Note: This assumes Symfony's collection prototype is available
  // You may need to adjust based on your actual form rendering
});
</script>

<style>
.nav-tabs .nav-link {
  color: #6c757d;
  border: none;
  border-bottom: 3px solid transparent;
  padding: 0.75rem 1.5rem;
}

.nav-tabs .nav-link:hover {
  border-bottom-color: #dee2e6;
  color: #495057;
}

.nav-tabs .nav-link.active {
  color: #0d6efd;
  border-bottom-color: #0d6efd;
  background: none;
}

.form-label.fw-bold {
  font-size: 0.95rem;
  color: #495057;
  margin-bottom: 0.5rem;
}

.form-control:focus, .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
}
</style>
{% endblock %}
